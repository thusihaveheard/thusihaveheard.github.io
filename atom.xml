<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Amote</title>
  <icon>https://www.gravatar.com/avatar/2d43ac97653017ba500ce506cb7c8500</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://amote.xin/"/>
  <updated>2018-12-14T08:42:32.655Z</updated>
  <id>https://amote.xin/</id>
  
  <author>
    <name>如是我闻</name>
    <email>shuaichaogao@gamil.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>centos7搭建docker私有镜像中心</title>
    <link href="https://amote.xin/2018/12/14/centos7%E6%90%AD%E5%BB%BAdocker%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%B8%AD%E5%BF%83/"/>
    <id>https://amote.xin/2018/12/14/centos7搭建docker私有镜像中心/</id>
    <published>2018-12-14T08:39:56.000Z</published>
    <updated>2018-12-14T08:42:32.655Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="[object Object]" scheme="https://amote.xin/categories/object-Object/"/>
    
    
      <category term="[object Object]" scheme="https://amote.xin/tags/object-Object/"/>
    
  </entry>
  
  <entry>
    <title>Devops搭建手冊</title>
    <link href="https://amote.xin/2018/12/13/Devops%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8A/"/>
    <id>https://amote.xin/2018/12/13/Devops搭建手冊/</id>
    <published>2018-12-13T09:35:06.000Z</published>
    <updated>2018-12-14T03:18:06.729Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Gitlab安装"><a href="#Gitlab安装" class="headerlink" title="Gitlab安装"></a>Gitlab安装</h1><h2 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h2><pre><code>dpkg --force-depends -i gitlab-ce_10.3.3-ce.0_amd64.deb</code></pre><h2 id="备份-etc-gitlab-gitlab-rb文件"><a href="#备份-etc-gitlab-gitlab-rb文件" class="headerlink" title="备份/etc/gitlab/gitlab.rb文件"></a>备份/etc/gitlab/gitlab.rb文件</h2><pre><code>cp gitlab.rb gitlab.rb.bak</code></pre><h2 id="修改-etc-gitlab-gitlab-rb文件"><a href="#修改-etc-gitlab-gitlab-rb文件" class="headerlink" title="修改/etc/gitlab/gitlab.rb文件"></a>修改/etc/gitlab/gitlab.rb文件</h2><pre><code>external_url &quot;http://gitlab.example.com&quot; 为 external_url &quot;http://ip地址&quot;</code></pre><h2 id="使修改生效"><a href="#使修改生效" class="headerlink" title="使修改生效"></a>使修改生效</h2><pre><code>sudo gitlab-ctl reconfigure</code></pre><h2 id="默认root账号，需添加密码"><a href="#默认root账号，需添加密码" class="headerlink" title="默认root账号，需添加密码"></a>默认root账号，需添加密码</h2><h2 id="访问url"><a href="#访问url" class="headerlink" title="访问url"></a>访问url</h2><pre><code>ip:端口号(默认80)</code></pre><h1 id="Nexus安装"><a href="#Nexus安装" class="headerlink" title="Nexus安装"></a>Nexus安装</h1><h2 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h2><p>cd /usr/local<br>mkdir nexus</p><h2 id="下载Nexus安装包，并解压文件"><a href="#下载Nexus安装包，并解压文件" class="headerlink" title="下载Nexus安装包，并解压文件"></a>下载Nexus安装包，并解压文件</h2><p>wget <a href="https://sonatype-download.global.ssl.fastly.net/nexus/oss/nexus-2.14.8-01-bundle.tar.gz" target="_blank" rel="noopener">https://sonatype-download.global.ssl.fastly.net/nexus/oss/nexus-2.14.8-01-bundle.tar.gz</a><br>tar -xzvf nexus-2.14.8-01-bundle.tar.gz -C nexus</p><h2 id="添加root用户"><a href="#添加root用户" class="headerlink" title="添加root用户"></a>添加root用户</h2><p>vi /usr/local/nexus/nexus-2.14.8-01/bin/nexus<br>添加 RUN_AS_USER=root<br>保存以上修改。<br>备注：修改前请先备份原始文件</p><h2 id="启动Nexus"><a href="#启动Nexus" class="headerlink" title="启动Nexus"></a>启动Nexus</h2><p>/usr/local/nexus/ nexus-2.14.8-01/bin/nexus start</p><h2 id="访问Nexus"><a href="#访问Nexus" class="headerlink" title="访问Nexus"></a>访问Nexus</h2><p>ip:端口号(默认8081)/nexus</p><h2 id="默认Nexus账号密码"><a href="#默认Nexus账号密码" class="headerlink" title="默认Nexus账号密码"></a>默认Nexus账号密码</h2><p>admin admin123</p><p>注意：下载Nexus安装包的过程可以在本机操作，然后把安装包通过FTP上传到服务器上。<br>存储所在路径：压缩包解压后，文件夹内nexus-2.14.8-01-bundle/sonatype-work/，这个路径就是，具体存储路径可以在nexus-2.14.8-01/conf/ nexus.properties文件里进行修改。<br>参考：<a href="https://www.linuxidc.com/Linux/2016-08/134617.htm" target="_blank" rel="noopener">https://www.linuxidc.com/Linux/2016-08/134617.htm</a></p><h1 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h1><h2 id="FTP上传Docker的deb安装文件"><a href="#FTP上传Docker的deb安装文件" class="headerlink" title="FTP上传Docker的deb安装文件"></a>FTP上传Docker的deb安装文件</h2><p>比如上传到此目录下：/tmp/docker-ce_17.12.1_ce-0_ubuntu_amd64.deb</p><h2 id="更新库，安装依赖"><a href="#更新库，安装依赖" class="headerlink" title="更新库，安装依赖"></a>更新库，安装依赖</h2><p>apt-get update<br>apt-get install -y apt-utils iptables libdevmapper1.02.1 libltdl7 libseccomp2</p><h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>dpkg -i /tmp/docker-ce_17.12.1_ce-0_ubuntu_amd64.deb</p><h2 id="验证安装是否成功"><a href="#验证安装是否成功" class="headerlink" title="验证安装是否成功"></a>验证安装是否成功</h2><p>docker –version<br>如下图，显示docker版本号则安装成功<br><img src="/2018/12/13/Devops搭建手冊/1.png"></p><h1 id="Kubectl安装"><a href="#Kubectl安装" class="headerlink" title="Kubectl安装"></a>Kubectl安装</h1><h2 id="下载kubectl安装包"><a href="#下载kubectl安装包" class="headerlink" title="下载kubectl安装包"></a>下载kubectl安装包</h2><p>wget <a href="https://dl.k8s.io/v1.9.3/kubernetes-client-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.9.3/kubernetes-client-linux-amd64.tar.gz</a></p><h2 id="解压kubectl安装包"><a href="#解压kubectl安装包" class="headerlink" title="解压kubectl安装包"></a>解压kubectl安装包</h2><p>tar -zxvf kubernetes-client-linux-amd64.tar.gz</p><h2 id="进入到kubernetes-client-bin目录，并给kubectl文件赋权限"><a href="#进入到kubernetes-client-bin目录，并给kubectl文件赋权限" class="headerlink" title="进入到kubernetes/client/bin目录，并给kubectl文件赋权限"></a>进入到kubernetes/client/bin目录，并给kubectl文件赋权限</h2><p>cd kubernetes/client/bin<br>chmod +x ./kubectl</p><h2 id="移动kubectl文件到-usr-local-bin-目录下"><a href="#移动kubectl文件到-usr-local-bin-目录下" class="headerlink" title="移动kubectl文件到/usr/local/bin/目录下"></a>移动kubectl文件到/usr/local/bin/目录下</h2><p>sudo mv ./kubectl /usr/local/bin/kubectl<br>sudo chmod +x /usr/local/bin/kubectl</p><h2 id="创建-kube文件夹"><a href="#创建-kube文件夹" class="headerlink" title="创建.kube文件夹"></a>创建.kube文件夹</h2><p>mkdir ~/.kube</p><h2 id="创建config文件"><a href="#创建config文件" class="headerlink" title="创建config文件"></a>创建config文件</h2><p>touch ~/.kube/config</p><h2 id="K8S的配置信息"><a href="#K8S的配置信息" class="headerlink" title="K8S的配置信息"></a>K8S的配置信息</h2><h3 id="通过token添加配置信息"><a href="#通过token添加配置信息" class="headerlink" title="通过token添加配置信息"></a>通过token添加配置信息</h3><p>首先：web登录到ICP<br> <img src="/2018/12/13/Devops搭建手冊/2.png"><br>其次：复制token信息<br> <img src="/2018/12/13/Devops搭建手冊/3.png"><br>最后：在服务器命令行执行token信息里的命令，执行完之后步骤6里的config文件里会保存有k8s的相关配置信息，但是token是有实效期的。</p><h3 id="通过证书添加配置信息"><a href="#通过证书添加配置信息" class="headerlink" title="通过证书添加配置信息"></a>通过证书添加配置信息</h3><p>首先：向ICP管理员要三个证书，三个证书在ICP的master节点上的路径为/etc/cfc/conf/，三个证书为：ca.crt，kubecfg.crt，kubecfg.key，将三个证书存放到/etc/kubernetes/conf/目录下，如果没有请创建该目录<br>其次：执行kubectl命令，修改config文件。<br>kubectl config set-cluster mycluster.icp  –server=<a href="https://10.8.154.198:8001" target="_blank" rel="noopener">https://10.8.154.198:8001</a>  –certificate-authority=/etc/kubernetes/conf/ca.crt \<br>&amp;&amp; kubectl config set-credentials admin –client-certificate=/etc/kubernetes/conf/kubecfg.crt –client-key=/etc/kubernetes/conf/kubecfg.key \<br>&amp;&amp; kubectl config set-context icp –cluster=mycluster.icp –user=admin \<br>&amp;&amp; kubectl config use-context icp \<br>&amp;&amp; kubectl config view</p><p>下载地址：<br><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md</a><br>​                    参考：<br>​                        <a href="http://blog.csdn.net/farYang/article/details/79427573" target="_blank" rel="noopener">http://blog.csdn.net/farYang/article/details/79427573</a><br>​                        <a href="http://blog.csdn.net/weiguang1017/article/details/69972015" target="_blank" rel="noopener">http://blog.csdn.net/weiguang1017/article/details/69972015</a><br>​                    注意：<br>1.压缩包里只有一个kubectl文件，1,、2、3、4步已经安装好kubectl了，只是不能与k8s通讯。<br>2.证书配置是针对管理员的，普通用户用token<br>3.修改host文件.如：10.8.154.198  mycluster.icp</p><ol start="4"><li>7步骤b)中的–server= <a href="https://10.8.154.198:8001要进行修改" target="_blank" rel="noopener">https://10.8.154.198:8001要进行修改</a></li></ol><h1 id="Jenkins安装"><a href="#Jenkins安装" class="headerlink" title="Jenkins安装"></a>Jenkins安装</h1><h2 id="向ICP管理员索要四个证书，master三个证书，私有镜像中心一个证书。如下图所示："><a href="#向ICP管理员索要四个证书，master三个证书，私有镜像中心一个证书。如下图所示：" class="headerlink" title="向ICP管理员索要四个证书，master三个证书，私有镜像中心一个证书。如下图所示："></a>向ICP管理员索要四个证书，master三个证书，私有镜像中心一个证书。如下图所示：</h2> <img src="/2018/12/13/Devops搭建手冊/4.png"><p>将master的上个证书存放到：/etc/kubernetes/conf/<br>将私有镜像中心的证书存放到：/etc/docker/certs.d/mycluster.icp:8500/</p><p>注意：证书原始路径，在ICP的master节点上<br>​    Master证书路径：/etc/cfc/conf/ca.crt<br>/etc/cfc/conf/kubecfg.crt<br>/etc/cfc/conf/kubecfg.key<br>​            私有镜像中心证书路径：/etc/docker/certs.d/mycluster.icp\:8500/ca.crt</p><h2 id="向ICP管理员询问cluster-vip、cluster-CA-domain、proxy-vip、storageClassName的值"><a href="#向ICP管理员询问cluster-vip、cluster-CA-domain、proxy-vip、storageClassName的值" class="headerlink" title="向ICP管理员询问cluster_vip、cluster_CA_domain、proxy_vip、storageClassName的值"></a>向ICP管理员询问cluster_vip、cluster_CA_domain、proxy_vip、storageClassName的值</h2><p>cluster_vip：页面访问ICP的IP地址<br>​    cluster_CA_domain：私有镜像中心域名<br>​    proxy_vip：代理的vip，用于应用的映射<br>​    storageClassName：PVC的时候使用</p><h2 id="修改服务器的hosts文件，添加私有镜像中心的映射，如下图所示"><a href="#修改服务器的hosts文件，添加私有镜像中心的映射，如下图所示" class="headerlink" title="修改服务器的hosts文件，添加私有镜像中心的映射，如下图所示"></a>修改服务器的hosts文件，添加私有镜像中心的映射，如下图所示</h2> <img src="/2018/12/13/Devops搭建手冊/5.png"><h2 id="在k8s集群内新建devops命名空间"><a href="#在k8s集群内新建devops命名空间" class="headerlink" title="在k8s集群内新建devops命名空间"></a>在k8s集群内新建devops命名空间</h2><p>命令：kubectl create ns devops<br>ICP页面创建：<br> <img src="/2018/12/13/Devops搭建手冊/6.png"></p><h2 id="根据应用的场景创建java-slave-nodejs-slave等jenkins的slave镜像"><a href="#根据应用的场景创建java-slave-nodejs-slave等jenkins的slave镜像" class="headerlink" title="根据应用的场景创建java-slave,nodejs-slave等jenkins的slave镜像"></a>根据应用的场景创建java-slave,nodejs-slave等jenkins的slave镜像</h2><h2 id="从docker-hub上下载openjdk、nginx、jenkins等镜像"><a href="#从docker-hub上下载openjdk、nginx、jenkins等镜像" class="headerlink" title="从docker-hub上下载openjdk、nginx、jenkins等镜像"></a>从docker-hub上下载openjdk、nginx、jenkins等镜像</h2><h2 id="上传5、6步骤里的镜像到ICP的私有镜像中心"><a href="#上传5、6步骤里的镜像到ICP的私有镜像中心" class="headerlink" title="上传5、6步骤里的镜像到ICP的私有镜像中心"></a>上传5、6步骤里的镜像到ICP的私有镜像中心</h2><p>如何上传，请参考ICP官方文档：<br><a href="https://www.ibm.com/support/knowledgecenter/en/SSBS6K_2.1.0/manage_images/using_docker_cli.html" target="_blank" rel="noopener">https://www.ibm.com/support/knowledgecenter/en/SSBS6K_2.1.0/manage_images/using_docker_cli.html</a></p><h2 id="创建secret"><a href="#创建secret" class="headerlink" title="创建secret"></a>创建secret</h2><p>kubectl create secret docker-registry myregistrykey –docker-server=mycluster.icp:8500 –docker-username=admin –docker-password=admin <a href="mailto:--docker-email=shuaichao_gao@trtjk.com" target="_blank" rel="noopener">--docker-email=shuaichao_gao@trtjk.com</a> -n=devops<br>在jenkins的yaml里添加对该secret的引用</p><h2 id="执行jenkins、pvc等yaml文件"><a href="#执行jenkins、pvc等yaml文件" class="headerlink" title="执行jenkins、pvc等yaml文件"></a>执行jenkins、pvc等yaml文件</h2><p>kubectl apply -f jenkins-master-sts-dev-test.yaml<br>kubectl apply -f jenkins-slave-glusterfs-pvc.yaml</p><h2 id="查看jenkins的状态"><a href="#查看jenkins的状态" class="headerlink" title="查看jenkins的状态"></a>查看jenkins的状态</h2><p>#查看pod状态<br>kubectl get pods -n=devops</p><p>#查看pod详细描述信息<br>kubectl describe pods -n=devops</p><p>#查看应用的日志<br>kubectl logs -f pods -n=devops</p><h2 id="浏览器访问jenkins，按需安装必要插件"><a href="#浏览器访问jenkins，按需安装必要插件" class="headerlink" title="浏览器访问jenkins，按需安装必要插件"></a>浏览器访问jenkins，按需安装必要插件</h2><h2 id="在gitlab服务器修改hosts文件，添加jenkins应用的映射"><a href="#在gitlab服务器修改hosts文件，添加jenkins应用的映射" class="headerlink" title="在gitlab服务器修改hosts文件，添加jenkins应用的映射"></a>在gitlab服务器修改hosts文件，添加jenkins应用的映射</h2> <img src="/2018/12/13/Devops搭建手冊/7.png"><h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><h2 id="Gitlab、Nexus、Docker、Kubectl都是安装在ubuntu服务器上的，jenkins是安装在ICP上的。"><a href="#Gitlab、Nexus、Docker、Kubectl都是安装在ubuntu服务器上的，jenkins是安装在ICP上的。" class="headerlink" title="Gitlab、Nexus、Docker、Kubectl都是安装在ubuntu服务器上的，jenkins是安装在ICP上的。"></a>Gitlab、Nexus、Docker、Kubectl都是安装在ubuntu服务器上的，jenkins是安装在ICP上的。</h2><h2 id="各个软件的安装包和文件已打包"><a href="#各个软件的安装包和文件已打包" class="headerlink" title="各个软件的安装包和文件已打包"></a>各个软件的安装包和文件已打包</h2><h2 id="证书与ICP环境是对应的，不同的ICP环境证书是不一样的。"><a href="#证书与ICP环境是对应的，不同的ICP环境证书是不一样的。" class="headerlink" title="证书与ICP环境是对应的，不同的ICP环境证书是不一样的。"></a>证书与ICP环境是对应的，不同的ICP环境证书是不一样的。</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Gitlab安装&quot;&gt;&lt;a href=&quot;#Gitlab安装&quot; class=&quot;headerlink&quot; title=&quot;Gitlab安装&quot;&gt;&lt;/a&gt;Gitlab安装&lt;/h1&gt;&lt;h2 id=&quot;安装命令&quot;&gt;&lt;a href=&quot;#安装命令&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
      <category term="Devops" scheme="https://amote.xin/categories/Devops/"/>
    
    
      <category term="Devops" scheme="https://amote.xin/tags/Devops/"/>
    
  </entry>
  
  <entry>
    <title>尘归尘，土归土</title>
    <link href="https://amote.xin/2018/12/13/%E5%B0%98%E5%BD%92%E5%B0%98%EF%BC%8C%E5%9C%9F%E5%BD%92%E5%9C%9F/"/>
    <id>https://amote.xin/2018/12/13/尘归尘，土归土/</id>
    <published>2018-12-13T07:47:10.000Z</published>
    <updated>2018-12-13T07:47:10.730Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://amote.xin/2018/12/13/hello-world/"/>
    <id>https://amote.xin/2018/12/13/hello-world/</id>
    <published>2018-12-13T06:57:50.747Z</published>
    <updated>2017-10-28T00:39:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
